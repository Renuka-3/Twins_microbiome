---
title: "Untitled"
author: "Renuka"
date: "2024-01-04"
output: html_document
---

```{r core, echo=FALSE, message=FALSE, warning=FALSE, error=FALSE}
library(mia)
library(miaViz)
library(dplyr)

###core phyla
tse <- readRDS("data/twins_tse.rds")
tse <- relAbundanceCounts(tse)
tse_Phyla <- agglomerateByRank(tse, rank ="Phylum", onRankOnly=TRUE)
top_taxa <- getTopTaxa(tse_Phyla,top =4, detection = 0.1/100, prevalence = 1/100, method = "prevalence", assay_name = "relabundance")
Phyla_renamed <- lapply(rowData(tse)$Phylum,
                   function(x){if (x %in% top_taxa) {x} else {"Other"}})
rowData(tse)$Phylum <- as.character(Phyla_renamed)

merged <- mergeCols(tse, colData(tse)$Samples)
merged1 <- transformCounts(merged, abund_values = "counts",
                              method = "relabundance")

b <- plotAbundance(merged, assay_name="relabundance", rank = "Phylum",
              #order_rank_by="abund", 
              order_sample_by = "Samples", add_x_text = TRUE)+ labs(x = "Samples", y = "Relative abundance (%)", title = "Core phyla")
print(b)

#genera

tse <- readRDS("data/twins_tse.rds")
tse <- relAbundanceCounts(tse)
tse_G <- agglomerateByRank(tse, rank ="Genus", onRankOnly=TRUE)
top_taxa <- getTopTaxa(tse_G,top =6, detection = 0.1/100, prevalence = 1/100, method = "prevalence", assay_name = "relabundance")
G_renamed <- lapply(rowData(tse)$Genus,
                   function(x){if (x %in% top_taxa) {x} else {"Other"}})
rowData(tse)$Genus <- as.character(G_renamed)

merged <- mergeCols(tse, colData(tse)$Samples)
merged1 <- transformCounts(merged, abund_values = "counts",
                              method = "relabundance")

b <- plotAbundance(merged, assay_name="relabundance", rank = "Genus",
              #order_rank_by="abund", 
              order_sample_by = "Samples", add_x_text = TRUE)+ labs(x = "Samples", y = "Relative abundance (%)", title = "Core genera")
print(b)
```



## Most prevelent genera mean, median calculations

```{r core_mm, echo=FALSE, message=FALSE}
library(knitr)
library(tidyverse)
library(miaViz)

tse <- readRDS("data/twins_tse.rds")

# Agglomerate data
altExps(tse) <- splitByRanks(tse)

# Relative transform
altExp(tse, "Genus") <- transformAssay(altExp(tse, "Genus"), method = "relabundance")

# Calculate mean
rowData(altExp(tse, "Genus"))[["mean"]] <- rowData(altExp(tse, "Genus"))[["mean"]] <- rowMeans(assay(altExp(tse, "Genus"), "relabundance"))
#rowData(altExp(tse, "Genus"))[["mean"]] <- round(100 *(rowMeans(assay(altExp(tse, "Genus"), "relabundance"),1))

# Calculate median
rowData(altExp(tse, "Genus"))[["median"]] <- rowMedians(assay(altExp(tse, "Genus"), "relabundance"))

# Get table,, order features based on median value, take only top 6
df <- rowData(altExp(tse, "Genus"))
df <- df[ order(df[["median"]], decreasing = TRUE), ]
df[1:6, ]

head(getPrevalence(tse, rank = "Genus", detection = 0.01/100, sort = TRUE,
                   assay.type = "counts", as_relative = TRUE))


#####plyla

tse <- readRDS("data/twins_tse.rds")

# Agglomerate data
altExps(tse) <- splitByRanks(tse)

# Relative transform
altExp(tse, "Phylum") <- transformAssay(altExp(tse, "Phylum"), method = "relabundance")

# Calculate mean
rowData(altExp(tse, "Phylum"))[["mean"]] <- rowData(altExp(tse, "Phylum"))[["mean"]] <- rowMeans(assay(altExp(tse, "Phylum"), "relabundance"))
#rowData(altExp(tse, "Genus"))[["mean"]] <- round(100 *(rowMeans(assay(altExp(tse, "Genus"), "relabundance"),1))

# Calculate median
rowData(altExp(tse, "Phylum"))[["median"]] <- rowMedians(assay(altExp(tse, "Phylum"), "relabundance"))

# Get table,, order features based on median value, take only top 6
df <- rowData(altExp(tse, "Phylum"))
df <- df[ order(df[["median"]], decreasing = TRUE), ]
df[1:6, ]

head(getPrevalence(tse, rank = "Phylum", detection = 0.01/100, sort = TRUE,
                   assay.type = "counts", as_relative = TRUE))
```

