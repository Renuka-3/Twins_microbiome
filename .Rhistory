tse <- transformSamples(tse, method = "pa")
tse <- runMDS(tse, FUN = vegan::vegdist, method = "jaccard", name = "PCoA_J", exprs_values = "pa")
# Extract coords + metadata
coords <- as.data.frame(reducedDim(tse, "PCoA_J"))
coords$Geographical_location <- colData(tse)$Geographical_location
coords$Pair <- factor(colData(tse)$Pair)  # Add twin pair as factor
# Auto detect first two dimensions for plotting
xvar <- colnames(coords)[1]
yvar <- colnames(coords)[2]
# Explained variance for axis labels
e <- attr(reducedDim(tse, "PCoA_J"), "eig")
rel_eig <- e/sum(e[e > 0])
# Choose 13 distinct shapes
shape.values <- c(0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12)
# Final combined plot
p <- ggplot(coords, aes_string(x = xvar, y = yvar)) +
# Add ellipses for each geographic group
stat_ellipse(
aes(color = Geographical_location, fill = Geographical_location, group = Geographical_location),
geom = "polygon", alpha = 0.15, show.legend = FALSE
) +
# Add points with color = geography, shape = Twin pair
geom_point(aes(color = Geographical_location, shape = Pair), size = 2) +
# Manual scales
scale_color_manual(values = c(
"Nashik"     = "#2CA02C",
"Ahmednagar" = "orange",
"Pune"       = "#1F77B4"
)) +
scale_fill_manual(values = c(
"Nashik"     = "#2CA02C",
"Ahmednagar" = "orange",
"Pune"       = "#1F77B4"
)) +
scale_shape_manual(values = shape.values) +
# Labels & theme
labs(
x = paste0("PCoA1 (", round(100 * rel_eig[1], 1), "%)"),
y = paste0("PCoA2 (", round(100 * rel_eig[2], 1), "%)"),
title = "a. Geographical location",
shape = "Twin Pair",
color = "Geographical location",
fill = "Geographical location"
) +
guides(
shape = guide_legend(nrow = 3, byrow = TRUE),
color = guide_legend(nrow = 3, byrow = TRUE),
fill  = guide_legend(nrow = 3, byrow = TRUE)
) +
theme_minimal() +
theme(
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
axis.line = element_line(color = "black"),
axis.text = element_text(size = 13),
axis.title = element_text(size = 13),
plot.title = element_text(size = 16),
legend.position = "bottom",
legend.text = element_text(size = 10)
)
print(p)
coords <- as.data.frame(reducedDim(tse, "PCoA_J"))
coords$Diet <- colData(tse)$Diet
coords$Pair <- factor(colData(tse)$Pair)  # Add twin pair as factor
# Auto detect first two dimensions for plotting
xvar <- colnames(coords)[1]
yvar <- colnames(coords)[2]
# Explained variance for axis labels
e <- attr(reducedDim(tse, "PCoA_J"), "eig")
rel_eig <- e/sum(e[e > 0])
# Choose 13 distinct shapes
shape.values <- c(0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12)
# Final combined plot
p1 <- ggplot(coords, aes_string(x = xvar, y = yvar)) +
stat_ellipse(
aes(color = Diet, fill = Diet, group = Diet),
geom = "polygon", alpha = 0.15, show.legend = FALSE
) + geom_point(aes(color = Diet, shape = Pair), size = 2) +
scale_shape_manual(values = shape.values) +
labs(x = paste0("PCoA1 (", round(100 * rel_eig[1], 1), "%)"),
y = paste0("PCoA2 (", round(100 * rel_eig[2], 1), "%)"),
title = "b. Diet",
shape = "Twin Pair",
color = "Diet",
fill = "Diet") +guides(shape = guide_legend(nrow = 3, byrow = TRUE),
color = guide_legend(nrow = 3, byrow = TRUE),
fill  = guide_legend(nrow = 3, byrow = TRUE)) +
theme_minimal() +theme(panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
axis.line = element_line(color = "black"),
axis.text = element_text(size = 13),
axis.title = element_text(size = 13),
plot.title = element_text(size = 16),
legend.position = "bottom",
legend.text = element_text(size = 10))
print(p1)
coords <- as.data.frame(reducedDim(tse, "PCoA_J"))
coords$Gender <- colData(tse)$Gender
coords$Pair <- factor(colData(tse)$Pair)  # Add twin pair as factor
# Auto detect first two dimensions for plotting
xvar <- colnames(coords)[1]
yvar <- colnames(coords)[2]
# Explained variance for axis labels
e <- attr(reducedDim(tse, "PCoA_J"), "eig")
rel_eig <- e/sum(e[e > 0])
# Choose 13 distinct shapes
shape.values <- c(0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12)
# Final combined plot
p2 <- ggplot(coords, aes_string(x = xvar, y = yvar)) +
stat_ellipse(
aes(color = Gender, fill = Gender, group = Gender),
geom = "polygon", alpha = 0.15, show.legend = FALSE
) + geom_point(aes(color = Gender, shape = Pair), size = 2) +
scale_shape_manual(values = shape.values) +
labs(x = paste0("PCoA1 (", round(100 * rel_eig[1], 1), "%)"),
y = paste0("PCoA2 (", round(100 * rel_eig[2], 1), "%)"),
title = "c. Gender",
shape = "Twin Pair",
color = "Gender",
fill = "Gender") +guides(shape = guide_legend(nrow = 2, byrow = TRUE),
color = guide_legend(nrow = 2, byrow = TRUE),
fill  = guide_legend(nrow = 2, byrow = TRUE)) +
theme_minimal() +theme(panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
axis.line = element_line(color = "black"),
axis.text = element_text(size = 13),
axis.title = element_text(size = 13),
plot.title = element_text(size = 16),
legend.position = "bottom",
legend.text = element_text(size = 10))
print(p2)
gridExtra::grid.arrange(p, p1, p2, ncol = 3)
# Final combined plot
p1 <- ggplot(coords, aes_string(x = xvar, y = yvar)) +
stat_ellipse(
aes(color = Diet, fill = Diet, group = Diet),
geom = "polygon", alpha = 0.15, show.legend = FALSE
) + geom_point(aes(color = Diet, shape = Pair), size = 2) +
scale_shape_manual(values = shape.values) +
labs(x = paste0("PCoA1 (", round(100 * rel_eig[1], 1), "%)"),
y = paste0("PCoA2 (", round(100 * rel_eig[2], 1), "%)"),
title = "b. Diet",
shape = "Twin Pair",
color = "Diet",
fill = "Diet") +guides(shape = guide_legend(nrow = 3, byrow = TRUE),
color = guide_legend(nrow = 3, byrow = TRUE),
fill  = guide_legend(nrow = 3, byrow = TRUE)) +
theme_minimal() +theme(panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
axis.line = element_line(color = "black"),
axis.text = element_text(size = 13),
axis.title = element_text(size = 13),
plot.title = element_text(size = 16),
legend.position = "none",
legend.text = element_text(size = 10))
print(p1)
coords <- as.data.frame(reducedDim(tse, "PCoA_J"))
coords$Diet <- colData(tse)$Diet
coords$Pair <- factor(colData(tse)$Pair)  # Add twin pair as factor
# Auto detect first two dimensions for plotting
xvar <- colnames(coords)[1]
yvar <- colnames(coords)[2]
# Explained variance for axis labels
e <- attr(reducedDim(tse, "PCoA_J"), "eig")
rel_eig <- e/sum(e[e > 0])
# Choose 13 distinct shapes
shape.values <- c(0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12)
# Final combined plot
p1 <- ggplot(coords, aes_string(x = xvar, y = yvar)) +
stat_ellipse(
aes(color = Diet, fill = Diet, group = Diet),
geom = "polygon", alpha = 0.15, show.legend = FALSE
) + geom_point(aes(color = Diet, shape = Pair), size = 2) +
scale_shape_manual(values = shape.values) +
labs(x = paste0("PCoA1 (", round(100 * rel_eig[1], 1), "%)"),
y = paste0("PCoA2 (", round(100 * rel_eig[2], 1), "%)"),
title = "b. Diet",
shape = "Twin Pair",
color = "Diet",
fill = "Diet") +guides(shape = guide_legend(nrow = 3, byrow = TRUE),
color = guide_legend(nrow = 3, byrow = TRUE),
fill  = guide_legend(nrow = 3, byrow = TRUE)) +
theme_minimal() +theme(panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
axis.line = element_line(color = "black"),
axis.text = element_text(size = 13),
axis.title = element_text(size = 13),
plot.title = element_text(size = 16),
legend.position = "none",
legend.text = element_text(size = 10))
print(p1)
################## gender
coords <- as.data.frame(reducedDim(tse, "PCoA_J"))
coords$Gender <- colData(tse)$Gender
coords$Pair <- factor(colData(tse)$Pair)  # Add twin pair as factor
# Auto detect first two dimensions for plotting
xvar <- colnames(coords)[1]
yvar <- colnames(coords)[2]
# Explained variance for axis labels
e <- attr(reducedDim(tse, "PCoA_J"), "eig")
rel_eig <- e/sum(e[e > 0])
# Choose 13 distinct shapes
shape.values <- c(0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12)
# Final combined plot
p2 <- ggplot(coords, aes_string(x = xvar, y = yvar)) +
stat_ellipse(
aes(color = Gender, fill = Gender, group = Gender),
geom = "polygon", alpha = 0.15, show.legend = FALSE
) + geom_point(aes(color = Gender, shape = Pair), size = 2) +
scale_shape_manual(values = shape.values) +
labs(x = paste0("PCoA1 (", round(100 * rel_eig[1], 1), "%)"),
y = paste0("PCoA2 (", round(100 * rel_eig[2], 1), "%)"),
title = "c. Gender",
shape = "Twin Pair",
color = "Gender",
fill = "Gender") +guides(shape = guide_legend(nrow = 2, byrow = TRUE),
color = guide_legend(nrow = 2, byrow = TRUE),
fill  = guide_legend(nrow = 2, byrow = TRUE)) +
theme_minimal() +theme(panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
axis.line = element_line(color = "black"),
axis.text = element_text(size = 13),
axis.title = element_text(size = 13),
plot.title = element_text(size = 16),
legend.position = "none",
legend.text = element_text(size = 10))
print(p2)
gridExtra::grid.arrange(p, p1, p2, ncol = 3)
## PERMANOVA analysis
tse <- readRDS("data/twins_tse.rds")
# Agglomerate data to genus level
tse <- agglomerateByRank(tse, rank = "Genus")
# Transform data to presence/absence (0/1)
tse <- transformSamples(tse, method = "pa")
# Compute Jaccard distance on transposed presence/absence assay
pa_matrix <- t(assay(tse, "pa"))
jaccard_dist <- vegdist(pa_matrix, method = "jaccard", binary = TRUE)
set.seed(413)
temp <- anova(
betadisper(
vegdist(t(assay(tse,"pa")), method = "jaccard"),
group = colData(tse)[,"Geographical_location"]))
set.seed(1576)
# We choose 999 random permutations
permanova <- adonis2(t(assay(tse,"pa")) ~ Geographical_location + Diet + Gender,
by = "margin",
data = colData(tse),
method = "jaccard",
permutations = 999)
head(permanova)
tseE <- tse[,!(colnames(tse) %in% c("T1B", "T2A", "T3B", "T4A", "T5B", "T6A", "T7A", "T8A", "T9A", "T10A", "T11B", "T12A", "T13B"))]
set.seed(1234)
set.seed(2123)
permanova <- adonis2(t(assay(tseE,"pa")) ~ Geographical_location + Diet + Gender,
by = "margin",
data = colData(tseE),
method = "jaccard",
permutations = 999)
head(permanova)
set.seed(1234)
permanova <- adonis2(t(assay(tseE,"pa")) ~ Geographical_location + Diet + Gender,
by = "margin",
data = colData(tseE),
method = "jaccard",
permutations = 999)
head(permanova)
library(mia)
library(vegan)
library(ggplot2)
library(scater)
library(ggrepel)
library(gridExtra)
library(vegan)
library(gridExtra)
rmarkdown::render("beta.Rmd", "md_document")
library(knitr)
library(tidyverse)
library(tidyverse)
library(miaViz)
library(viridis)
# 1. Load & preprocess data
tse <- readRDS("data/twins_tse.rds")
tse <- transformAssay(tse, assay.type = "counts", method = "relabundance")
tse <- agglomerateByRank(tse, rank = "Phylum")
tse <- agglomerateByRank(tse, rank = "Phylum")
top_taxa <- getTop(tse,
top = 3,
assay.type = "relabundance",
detection = 0.1,
prevalence = 0.2)
phylum_renamed <- lapply(rowData(tse)$Phylum, function(x) {
if (x %in% top_taxa) x else "Other"
})
rowData(tse)$Phylum_sub <- as.character(phylum_renamed)
tse_sub <- agglomerateByVariable(tse, by = "rows", f = "Phylum_sub")
# 2. Extract abundance data & reshape long
relab <- assay(tse_sub, "relabundance")
df <- as.data.frame(relab)
df$Phylum <- rowData(tse_sub)$Phylum_sub
df_long <- df %>%
pivot_longer(
cols = -Phylum,
names_to = "Sample",
values_to = "Abundance"
)
# 3. Define the sample order (in correct pairing order)
# Replace below vector with your actual sample names and correct order
sample_order <- c("T12A","T12B",
"T13A","T13B",
"T1A","T1B",
"T3A","T3B",
"T10A","T10B",
"T2A","T2B",
"T4A","T4B",
"T5A","T5B",
"T6A","T6B",
"T7A","T7B",
"T8A","T8B",
"T9A","T9B",
"T11A","T11B")
if (!all(sample_order %in% unique(df_long$Sample))) {
stop("Some sample_order names not found in df_long$Sample")
}
# 4. Compute numeric x‑positions with consistent gap after each pair
# We'll define: each pair occupies two consecutive positions, then we add a fixed gap
pair_gap <- 1  # gap width; adjust if you want larger horizontal spacing between pairs
bar_spacing <- 1  # internal spacing increment for each bar — these are integer steps
# Build x positions vector:
x_positions <- unlist(
lapply(seq(1, length(sample_order), by = 2), function(i) {
# for each pair:
s1 <- sample_order[i]
if (i + 1 <= length(sample_order)) {
s2 <- sample_order[i + 1]
# assign x positions (bar1, bar2), then a gap (bar + gap)
c(NA, NA, NA)  # we'll replace with actual numeric values below
} else {
c(NA, NA, NA)
}
})
)
# Actually simpler: build manually
x_vals <- numeric(length(sample_order))
current_x <- 1
for(i in seq(1, length(sample_order), by = 2)) {
x_vals[i] <- current_x
if (i + 1 <= length(sample_order)) {
x_vals[i+1] <- current_x + bar_spacing
}
# after the pair, increment current_x by bar_spacing * 2 + pair_gap
current_x <- current_x + bar_spacing * 2 + pair_gap
}
sample_x <- tibble(
Sample = sample_order,
x = x_vals
)
# 5. Merge with long data — using explicit dplyr::left_join to avoid conflicts
df_plot <- df_long %>%
filter(Sample %in% sample_order) %>%
dplyr::left_join(sample_x, by = "Sample")
# 6. Plot with ggplot2
library(ggplot2)
R <- ggplot(df_plot, aes(x = x, y = Abundance, fill = Phylum)) +
geom_col(width = 0.9) +
scale_fill_manual(values = c(
"Proteobacteria" = "#e7298a",
"Firmicutes"     = "#1b9e77",
"Bacteroidetes"  = "#7570b3",
"Actinobacteria" = "#66a61e",
"Other"          = "#fee08b"
), name = "Phylum") +
scale_x_continuous(
breaks = sample_x$x,
labels = sample_x$Sample,
expand = expansion(add = c(0.5, 0.5))
) +
scale_y_continuous(labels = scales::percent) +
labs(x = "Samples", y = "Relative abundance (%)", title = "") +
theme_classic() +
theme(
plot.title     = element_text(size = 15, face = 'bold'),
axis.title     = element_text(size = 15),
axis.text      = element_text(size = 15),
legend.title   = element_text(size = 15),
legend.text    = element_text(size = 15),
legend.key.size= unit(0.3, "cm"),
axis.text.x    = element_text(angle = 90, vjust = 0.5)
)
R
R <- ggplot(df_plot, aes(x = x, y = Abundance, fill = Phylum)) +
geom_col(width = 0.9) +
scale_fill_viridis_d(option = "viridis", begin = 0, end = 0.7) +
scale_y_continuous(labels = scales::percent) +
scale_x_continuous(
breaks = sample_x$x,
labels = sample_x$Sample,
expand = expansion(add = c(0.5, 0.5))
) +
labs(x = "Samples", y = "Relative abundance (%)") +
theme_classic() +
theme(
plot.title     = element_text(size = 15, face = 'bold'),
axis.title     = element_text(size = 15),
axis.text      = element_text(size = 14),
legend.title   = element_text(size = 15),
legend.text    = element_text(size = 15),
legend.key.size= unit(0.3, "cm"),
axis.text.x    = element_text(angle = 90, vjust = 0.5)
)
R
library(tidyverse)
library(miaViz)
# 1. Load & prepare data
tse <- readRDS("data/twins_tse.rds")
tse <- transformAssay(tse, assay.type = "counts", method = "relabundance")
tse <- agglomerateByRank(tse, rank = "Genus")
top_taxa <- getTop(
tse,
top = 5,
assay.type = "relabundance",
detection = 0.1,
prevalence = 0.2
)
genus_renamed <- lapply(rowData(tse)$Genus, function(x) {
if (x %in% top_taxa) x else "Other"
})
rowData(tse)$Genus_sub <- as.character(genus_renamed)
tse_sub <- agglomerateByVariable(tse, by = "rows", f = "Genus_sub")
# 2. Extract relative abundance, reshape to long format
relab <- assay(tse_sub, "relabundance")
df <- as.data.frame(relab)
df$Genus <- rowData(tse_sub)$Genus_sub
df_long <- df %>%
pivot_longer(
cols = -Genus,
names_to = "Sample",
values_to = "Abundance"
)
# 3. Define the sample‑order (paired) vector — adapt to your sample names
sample_order <- c(
"T12A","T12B",
"T13A","T13B",
"T1A","T1B",
"T3A","T3B",
"T10A","T10B",
"T2A","T2B",
"T4A","T4B",
"T5A","T5B",
"T6A","T6B",
"T7A","T7B",
"T8A","T8B",
"T9A","T9B",
"T11A","T11B"
)
# adjust this vector to exactly match your sample names
if (!all(sample_order %in% unique(df_long$Sample))) {
stop("Some sample_order names are not present in df_long$Sample — check spelling/order")
}
# 4. Create numeric x‑positions with gap after every pair
bar_spacing <- 1
pair_gap   <- 1.5  # tweak this value to control gap width between pairs
x_vals <- numeric(length(sample_order))
current_x <- 1
for (i in seq(1, length(sample_order), by = 2)) {
x_vals[i] <- current_x
if (i + 1 <= length(sample_order)) {
x_vals[i + 1] <- current_x + bar_spacing
}
current_x <- current_x + 2*bar_spacing + pair_gap
}
sample_x <- tibble(Sample = sample_order, x = x_vals)
# 5. Merge with long data (use dplyr to avoid conflicts from miaViz)
df_plot <- df_long %>%
filter(Sample %in% sample_order) %>%
dplyr::left_join(sample_x, by = "Sample")
# 6. Plot with ggplot2 using default colour scale (no manual fill) + defined spacing
library(ggplot2)
cbf_colors <- c(
"#999999",   # Gray
"#E69F00",  # Orange
"#009E73",  # Bluish Green
"#0072B2",  # Blue
"#D55E00",  # Vermilion
"#CC79A7"  # Reddish Purple
)
Q<- ggplot(df_plot, aes(x = x, y = Abundance, fill = Genus)) +
geom_col(width = bar_spacing * 0.9) +  # controls bar thickness
scale_fill_manual(values = cbf_colors) +
scale_y_continuous(labels = scales::percent) +
scale_x_continuous(
breaks = sample_x$x,
labels = sample_x$Sample,
expand = expansion(add = c(0.5, 0.5))
) +
labs(
x = "Samples",
y = "Relative abundance (%)",
title = ""
) +
theme_classic() +
theme(
plot.title      = element_text(size = 16, face = "bold"),
axis.title      = element_text(size = 15),
axis.text       = element_text(size = 14),
legend.title    = element_text(size = 15),
legend.text     = element_text(size = 15),
legend.key.size = unit(0.3, "cm"),
axis.text.x     = element_text(angle = 90, vjust = 0.5)
)
print(Q)
Q
rmarkdown::render("core.Rmd", output_format = "md_document")
